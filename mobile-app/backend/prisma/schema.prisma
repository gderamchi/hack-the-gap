generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AnalysisHistory {
  id              String     @id
  influencerId    String
  trustScore      Float
  dramaCount      Int
  goodActionCount Int
  neutralCount    Int
  avgSentiment    Float
  analyzedAt      DateTime   @default(now())
  Influencer      Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@index([analyzedAt])
  @@index([influencerId])
}

model ClaimRequest {
  id           String     @id
  influencerId String
  userId       String
  status       String     @default("PENDING")
  proofType    String?
  proofUrl     String?
  proofText    String?
  reviewedBy   String?
  reviewedAt   DateTime?
  reviewNotes  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  Influencer   Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  User         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([influencerId])
  @@index([status])
  @@index([userId])
}

model CommunitySignal {
  id                 String               @id
  userId             String
  influencerId       String
  type               String
  rating             Int?
  comment            String?
  tags               String?
  isVerified         Boolean              @default(false)
  verifiedAt         DateTime?
  isHidden           Boolean              @default(false)
  hiddenReason       String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  contentHash        String?
  duplicateOf        String?
  emailSent          Boolean              @default(false)
  emailSentAt        DateTime?
  isDuplicate        Boolean              @default(false)
  rejectionReason    String?
  status             String               @default("PENDING")
  verificationResult String?
  verifiedBy         String?
  Influencer         Influencer           @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  User               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  InfluencerResponse InfluencerResponse[]

  @@index([createdAt])
  @@index([influencerId])
  @@index([status])
  @@index([type])
  @@index([userId])
}

model CommunityTrustScore {
  id                   String     @id
  influencerId         String     @unique
  avgRating            Float      @default(0.0)
  totalRatings         Int        @default(0)
  totalDramaReports    Int        @default(0)
  totalPositiveReports Int        @default(0)
  totalComments        Int        @default(0)
  communityScore       Float      @default(50.0)
  combinedScore        Float      @default(50.0)
  lastUpdated          DateTime
  Influencer           Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@index([combinedScore])
  @@index([communityScore])
}

model DeepSearchAnalysis {
  id               String            @id
  influencerId     String
  status           String            @default("PENDING")
  analysisData     String?
  queriesRun       Int               @default(0)
  sourcesAnalyzed  Int               @default(0)
  processingTimeMs Int?
  isPublic         Boolean           @default(false)
  firstBuyerId     String?
  unlockedAt       DateTime?
  basePrice        Float             @default(99.99)
  createdAt        DateTime          @default(now())
  completedAt      DateTime?
  User             User?             @relation(fields: [firstBuyerId], references: [id])
  Influencer       Influencer        @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  DeepSearchOrder  DeepSearchOrder[]

  @@index([influencerId])
  @@index([isPublic])
  @@index([status])
}

model DeepSearchOrder {
  id                 String             @id
  userId             String
  deepSearchId       String
  status             String             @default("PENDING")
  amount             Float
  currency           String             @default("EUR")
  platformFee        Float
  isFirstBuyer       Boolean            @default(false)
  wasFree            Boolean            @default(false)
  createdAt          DateTime           @default(now())
  paidAt             DateTime?
  DeepSearchAnalysis DeepSearchAnalysis @relation(fields: [deepSearchId], references: [id], onDelete: Cascade)
  User               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  Payment            Payment?

  @@index([deepSearchId])
  @@index([status])
  @@index([userId])
}

model Influencer {
  id                  String               @id
  name                String               @unique
  imageUrl            String?
  summary             String?
  socialHandles       String?
  niche               String?
  trustScore          Float                @default(50.0)
  dramaCount          Int                  @default(0)
  goodActionCount     Int                  @default(0)
  neutralCount        Int                  @default(0)
  avgSentiment        Float                @default(0.0)
  language            String               @default("fr")
  lastUpdated         DateTime
  createdAt           DateTime             @default(now())
  claimedAt           DateTime?
  claimedBy           String?
  isClaimed           Boolean              @default(false)
  verificationStatus  String               @default("UNCLAIMED")
  AnalysisHistory     AnalysisHistory[]
  ClaimRequest        ClaimRequest[]
  CommunitySignal     CommunitySignal[]
  CommunityTrustScore CommunityTrustScore?
  DeepSearchAnalysis  DeepSearchAnalysis[]
  InfluencerResponse  InfluencerResponse[]
  Mention             Mention[]

  @@index([isClaimed])
  @@index([name])
  @@index([trustScore])
}

model InfluencerResponse {
  id              String           @id
  influencerId    String
  mentionId       String?
  signalId        String?
  responseType    String
  responseText    String
  evidenceUrls    String?
  helpfulCount    Int              @default(0)
  notHelpfulCount Int              @default(0)
  isVerified      Boolean          @default(false)
  verifiedBy      String?
  verifiedAt      DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  Influencer      Influencer       @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  Mention         Mention?         @relation(fields: [mentionId], references: [id], onDelete: Cascade)
  CommunitySignal CommunitySignal? @relation(fields: [signalId], references: [id], onDelete: Cascade)
  ResponseVote    ResponseVote[]

  @@index([influencerId])
  @@index([mentionId])
  @@index([signalId])
}

model LeaderboardCache {
  id              String   @id
  leaderboardType String
  period          String
  data            String
  calculatedAt    DateTime @default(now())
  expiresAt       DateTime

  @@unique([leaderboardType, period])
  @@index([expiresAt])
  @@index([leaderboardType])
}

model Mention {
  id                 String               @id
  influencerId       String
  source             String
  sourceUrl          String
  textExcerpt        String
  sentimentScore     Float
  label              String
  scrapedAt          DateTime             @default(now())
  isVerified         Boolean              @default(false)
  scoreImpact        Float                @default(0.0)
  severity           String               @default("MEDIUM")
  verifiedAt         DateTime?
  verifiedBy         String?
  InfluencerResponse InfluencerResponse[]
  Influencer         Influencer           @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@index([influencerId])
  @@index([label])
  @@index([scrapedAt])
  @@index([severity])
}

model Payment {
  id                String          @id
  orderId           String          @unique
  userId            String
  provider          String
  providerPaymentId String?
  amount            Float
  currency          String          @default("EUR")
  status            String
  metadata          String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime
  DeepSearchOrder   DeepSearchOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  User              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
}

model ResponseVote {
  id                 String             @id
  responseId         String
  userId             String
  isHelpful          Boolean
  createdAt          DateTime           @default(now())
  InfluencerResponse InfluencerResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  User               User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([responseId, userId])
  @@index([responseId])
  @@index([userId])
}

model ReviewRequest {
  id           String    @id
  influencerId String
  mentionId    String?
  signalId     String?
  requestedBy  String
  requestType  String
  reason       String
  evidence     String?
  status       String    @default("PENDING")
  reviewedBy   String?
  reviewedAt   DateTime?
  reviewNotes  String?
  resolution   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime

  @@index([influencerId])
  @@index([requestedBy])
  @@index([status])
}

model ScoreImpactLog {
  id           String   @id
  influencerId String
  eventType    String
  eventId      String
  impactType   String
  impactAmount Float
  oldScore     Float
  newScore     Float
  reason       String
  details      String?
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([influencerId])
}

model TrendingInfluencer {
  id                 String   @id
  influencerId       String
  trendType          String
  trendScore         Float
  scoreChange        Float
  scoreChangePercent Float
  periodStart        DateTime
  periodEnd          DateTime
  reason             String?
  createdAt          DateTime @default(now())

  @@index([createdAt])
  @@index([influencerId])
  @@index([trendScore])
  @@index([trendType])
}

model User {
  id                  String               @id
  email               String               @unique
  passwordHash        String
  role                String               @default("COMMUNITY")
  status              String               @default("ACTIVE")
  firstName           String?
  lastName            String?
  company             String?
  avatar              String?
  subscriptionTier    String               @default("FREE")
  subscriptionStatus  String               @default("ACTIVE")
  subscriptionExpiry  DateTime?
  createdAt           DateTime             @default(now())
  lastLoginAt         DateTime?
  emailVerified       Boolean              @default(false)
  lastResetDate       DateTime             @default(now())
  monthlyReportsLimit Int                  @default(5)
  monthlyReportsUsed  Int                  @default(0)
  ClaimRequest        ClaimRequest[]
  CommunitySignal     CommunitySignal[]
  DeepSearchAnalysis  DeepSearchAnalysis[]
  DeepSearchOrder     DeepSearchOrder[]
  Payment             Payment[]
  ResponseVote        ResponseVote[]
  UserAchievement     UserAchievement[]
  UserEngagementStats UserEngagementStats?

  @@index([email])
  @@index([role])
}

model UserAchievement {
  id               String    @id
  userId           String
  achievementType  String
  achievementLevel Int       @default(1)
  progress         Int       @default(0)
  progressTarget   Int
  unlockedAt       DateTime?
  createdAt        DateTime  @default(now())
  User             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementType])
  @@index([achievementType])
  @@index([userId])
}

model UserEngagementStats {
  id               String    @id
  userId           String    @unique
  totalRatings     Int       @default(0)
  totalReports     Int       @default(0)
  totalComments    Int       @default(0)
  helpfulVotes     Int       @default(0)
  notHelpfulVotes  Int       @default(0)
  reputationScore  Float     @default(50.0)
  level            Int       @default(1)
  experiencePoints Int       @default(0)
  streak           Int       @default(0)
  lastActiveDate   DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
  User             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([level])
  @@index([reputationScore])
}
